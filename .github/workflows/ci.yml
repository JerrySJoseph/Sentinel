name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_check:
    name: Build check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      CI: "true"
      NODE_ENV: production
      NEXT_PUBLIC_AGENT_CORE_URL: http://localhost:3000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build (apps + packages)
        run: pnpm build

  unit_tests:
    name: Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      CI: "true"
      NODE_ENV: test
      NEXT_PUBLIC_AGENT_CORE_URL: http://localhost:3000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Unit tests (workspace)
        run: pnpm test


  e2e:
    name: E2E tests (Postgres)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: sentinel
          POSTGRES_PASSWORD: sentinel
          POSTGRES_DB: sentinel_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U sentinel"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

    env:
      CI: "true"
      NODE_ENV: test
      # Use a separate port to avoid clashing with local defaults.
      # Use 127.0.0.1 (not localhost) to avoid IPv6 ::1 resolution issues in CI.
      DATABASE_URL: postgresql://sentinel:sentinel@127.0.0.1:5433/sentinel_test?schema=public
      TEST_DATABASE_URL: postgresql://sentinel:sentinel@127.0.0.1:5433/sentinel_test?schema=public

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for Postgres (5433)
        run: node -e "const net=require('net');const host='127.0.0.1';const port=5433;const start=Date.now();(function ping(){const s=net.createConnection({host,port});s.on('connect',()=>{console.log('Postgres is reachable');s.end();});s.on('error',()=>{if(Date.now()-start>60_000){console.error('Timed out waiting for Postgres');process.exit(1);}setTimeout(ping,1000);});})();"

      - name: Build shared packages (required by agent-core tests)
        run: pnpm --filter @sentinel/config build && pnpm --filter @sentinel/kv build && pnpm --filter @sentinel/observability build && pnpm --filter @sentinel/agent build

      - name: Prisma generate (memory)
        run: pnpm -C packages/memory prisma:generate

      - name: Apply migrations (test DB)
        run: pnpm -C packages/memory prisma:migrate:deploy

      - name: Memory integration tests
        run: pnpm -C packages/memory exec jest --config jest.integration.config.js

      - name: agent-core e2e tests
        run: pnpm -C apps/agent-core exec jest --config ./test/jest-e2e.json

